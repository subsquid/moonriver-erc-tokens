import * as ethers from 'ethers';
import assert from 'assert';

export const abi = new ethers.utils.Interface(getJsonAbi());

export interface Approval0Event {
  owner: string;
  spender: string;
  value: ethers.BigNumber;
}

export interface Transfer0Event {
  from: string;
  to: string;
  value: ethers.BigNumber;
}

export interface EvmEvent {
  data: string;
  topics: string[];
}

export const events = {
  'Approval(address,address,uint256)': {
    topic: abi.getEventTopic('Approval(address,address,uint256)'),
    decode(data: EvmEvent): Approval0Event {
      const result = abi.decodeEventLog(
        abi.getEvent('Approval(address,address,uint256)'),
        data.data || '',
        data.topics
      );
      return {
        owner: result[0],
        spender: result[1],
        value: result[2]
      };
    }
  },
  'Transfer(address,address,uint256)': {
    topic: abi.getEventTopic('Transfer(address,address,uint256)'),
    decode(data: EvmEvent): Transfer0Event {
      const result = abi.decodeEventLog(
        abi.getEvent('Transfer(address,address,uint256)'),
        data.data || '',
        data.topics
      );
      return {
        from: result[0],
        to: result[1],
        value: result[2]
      };
    }
  }
};

interface ChainContext {
  _chain: Chain;
}

interface BlockContext {
  _chain: Chain;
  block: Block;
}

interface Block {
  height: number;
}

interface Chain {
  client: {
    call: <T = any>(method: string, params?: unknown[]) => Promise<T>;
  };
}

export class Contract {
  private readonly _chain: Chain;
  private readonly blockHeight: number;
  readonly address: string;

  constructor(ctx: BlockContext, address: string);
  constructor(ctx: ChainContext, block: Block, address: string);
  constructor(
    ctx: BlockContext,
    blockOrAddress: Block | string,
    address?: string
  ) {
    this._chain = ctx._chain;
    if (typeof blockOrAddress === 'string') {
      this.blockHeight = ctx.block.height;
      this.address = ethers.utils.getAddress(blockOrAddress);
    } else {
      assert(address != null);
      this.blockHeight = blockOrAddress.height;
      this.address = ethers.utils.getAddress(address);
    }
  }

  private async call(name: string, args: any[]): Promise<ReadonlyArray<any>> {
    const fragment = abi.getFunction(name);
    const data = abi.encodeFunctionData(fragment, args);
    const result = await this._chain.client.call('eth_call', [
      { to: this.address, data },
      this.blockHeight
    ]);
    return abi.decodeFunctionResult(fragment, result);
  }

  async name(): Promise<string> {
    const result = await this.call('name', []);
    return result[0];
  }

  async totalSupply(): Promise<ethers.BigNumber> {
    const result = await this.call('totalSupply', []);
    return result[0];
  }

  async decimals(): Promise<number> {
    const result = await this.call('decimals', []);
    return result[0];
  }

  async balanceOf(_owner: string): Promise<ethers.BigNumber> {
    const result = await this.call('balanceOf', [_owner]);
    return result[0];
  }

  async symbol(): Promise<string> {
    const result = await this.call('symbol', []);
    return result[0];
  }

  async allowance(_owner: string, _spender: string): Promise<ethers.BigNumber> {
    const result = await this.call('allowance', [_owner, _spender]);
    return result[0];
  }
}

function getJsonAbi(): any {
  return [
    {
      constant: true,
      inputs: [],
      name: 'name',
      outputs: [
        {
          name: '',
          type: 'string'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      constant: false,
      inputs: [
        {
          name: '_spender',
          type: 'address'
        },
        {
          name: '_value',
          type: 'uint256'
        }
      ],
      name: 'approve',
      outputs: [
        {
          name: '',
          type: 'bool'
        }
      ],
      payable: false,
      stateMutability: 'nonpayable',
      type: 'function'
    },
    {
      constant: true,
      inputs: [],
      name: 'totalSupply',
      outputs: [
        {
          name: '',
          type: 'uint256'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      constant: false,
      inputs: [
        {
          name: '_from',
          type: 'address'
        },
        {
          name: '_to',
          type: 'address'
        },
        {
          name: '_value',
          type: 'uint256'
        }
      ],
      name: 'transferFrom',
      outputs: [
        {
          name: '',
          type: 'bool'
        }
      ],
      payable: false,
      stateMutability: 'nonpayable',
      type: 'function'
    },
    {
      constant: true,
      inputs: [],
      name: 'decimals',
      outputs: [
        {
          name: '',
          type: 'uint8'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      constant: true,
      inputs: [
        {
          name: '_owner',
          type: 'address'
        }
      ],
      name: 'balanceOf',
      outputs: [
        {
          name: 'balance',
          type: 'uint256'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      constant: true,
      inputs: [],
      name: 'symbol',
      outputs: [
        {
          name: '',
          type: 'string'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      constant: false,
      inputs: [
        {
          name: '_to',
          type: 'address'
        },
        {
          name: '_value',
          type: 'uint256'
        }
      ],
      name: 'transfer',
      outputs: [
        {
          name: '',
          type: 'bool'
        }
      ],
      payable: false,
      stateMutability: 'nonpayable',
      type: 'function'
    },
    {
      constant: true,
      inputs: [
        {
          name: '_owner',
          type: 'address'
        },
        {
          name: '_spender',
          type: 'address'
        }
      ],
      name: 'allowance',
      outputs: [
        {
          name: '',
          type: 'uint256'
        }
      ],
      payable: false,
      stateMutability: 'view',
      type: 'function'
    },
    {
      payable: true,
      stateMutability: 'payable',
      type: 'fallback'
    },
    {
      anonymous: false,
      inputs: [
        {
          indexed: true,
          name: 'owner',
          type: 'address'
        },
        {
          indexed: true,
          name: 'spender',
          type: 'address'
        },
        {
          indexed: false,
          name: 'value',
          type: 'uint256'
        }
      ],
      name: 'Approval',
      type: 'event'
    },
    {
      anonymous: false,
      inputs: [
        {
          indexed: true,
          name: 'from',
          type: 'address'
        },
        {
          indexed: true,
          name: 'to',
          type: 'address'
        },
        {
          indexed: false,
          name: 'value',
          type: 'uint256'
        }
      ],
      name: 'Transfer',
      type: 'event'
    }
  ];
}
